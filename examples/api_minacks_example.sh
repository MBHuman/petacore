#!/bin/bash

# Пример настройки MIN_ACKS для PetaCore API

set -e

echo "=== Примеры настройки MIN_ACKS ==="
echo

echo "MIN_ACKS определяет минимальное количество подтверждений для quorum при чтении."
echo "Это влияет на баланс между консистентностью и производительностью."
echo

# Пример 1: Через переменные окружения
echo "=== 1. Настройка через переменные окружения при запуске ==="
echo
cat <<'EOF'
# MIN_ACKS=0 - строгий quorum (N/2 + 1, по умолчанию)
MIN_ACKS=0 NODE_ID=node-1 PORT=8080 go run cmd/api/main.go

# MIN_ACKS=-1 - все узлы (максимальная консистентность)
MIN_ACKS=-1 NODE_ID=node-2 PORT=8081 go run cmd/api/main.go

# MIN_ACKS=1 - один узел (слабая консистентность, быстро)
MIN_ACKS=1 NODE_ID=node-3 PORT=8082 go run cmd/api/main.go

# MIN_ACKS=2 - конкретное значение
MIN_ACKS=2 NODE_ID=node-4 PORT=8083 go run cmd/api/main.go
EOF
echo

# Пример 2: Динамическое изменение через API
echo "=== 2. Динамическое изменение через API (без перезапуска) ==="
echo
cat <<'EOF'
# Установить строгий quorum (N/2 + 1)
curl -X POST http://localhost:8081/config/min_acks \
  -H "Content-Type: application/json" \
  -d '{"min_acks":0}'

# Установить все узлы (N)
curl -X POST http://localhost:8081/config/min_acks \
  -H "Content-Type: application/json" \
  -d '{"min_acks":-1}'

# Установить один узел
curl -X POST http://localhost:8081/config/min_acks \
  -H "Content-Type: application/json" \
  -d '{"min_acks":1}'
EOF
echo

# Пример 3: Сравнительная таблица
echo "=== 3. Сравнение режимов MIN_ACKS ==="
echo
cat <<'EOF'
╔════════════╦═══════════════════╦═══════════════╦══════════════╦═══════════════════════════╗
║ MIN_ACKS   ║ Консистентность   ║ Скорость      ║ Доступность  ║ Использование             ║
╠════════════╬═══════════════════╬═══════════════╬══════════════╬═══════════════════════════╣
║ 1          ║ Слабая            ║ ⚡⚡⚡          ║ ✅✅✅       ║ Кеши, метрики             ║
║ 0 (N/2+1)  ║ Строгая (quorum)  ║ ⚡⚡           ║ ✅✅         ║ По умолчанию, продакшн    ║
║ -1 (N)     ║ Максимальная      ║ ⚡             ║ ✅           ║ Финансы, аудит, критично  ║
║ 2,3...     ║ Настраиваемая     ║ Зависит       ║ Зависит      ║ Особые требования         ║
╚════════════╩═══════════════════╩═══════════════╩══════════════╩═══════════════════════════╝

Для кластера из 3 узлов:
- MIN_ACKS=1: Данные доступны если хотя бы 1 узел их видит (быстро, но рискованно)
- MIN_ACKS=0: Преобразуется в 2 (большинство узлов, баланс)
- MIN_ACKS=-1: Преобразуется в 3 (все узлы должны подтвердить, медленно но надежно)
EOF
echo

# Пример 4: Практические сценарии
echo "=== 4. Практические сценарии использования ==="
echo
cat <<'EOF'
Сценарий 1: Кеш сессий (MIN_ACKS=1)
--------------------------------------
Требования: Высокая скорость, допустима eventual consistency
curl -X POST http://localhost:8081/config/min_acks -d '{"min_acks":1}'
curl -X POST http://localhost:8081/write -d '{"key":"session:abc123","value":"user_data"}'

Сценарий 2: Пользовательские данные (MIN_ACKS=0, по умолчанию)
---------------------------------------------------------------
Требования: Баланс между скоростью и надежностью
curl -X POST http://localhost:8081/config/min_acks -d '{"min_acks":0}'
curl -X POST http://localhost:8081/write -d '{"key":"user:123","value":"profile_data"}'

Сценарий 3: Финансовые транзакции (MIN_ACKS=-1)
------------------------------------------------
Требования: Максимальная консистентность, критичные данные
curl -X POST http://localhost:8081/config/min_acks -d '{"min_acks":-1}'
curl -X POST http://localhost:8081/write -d '{"key":"transaction:xyz","value":"1000.00"}'
EOF
echo

echo "=== Рекомендации ==="
echo
echo "✓ Разработка: MIN_ACKS=1 (быстро, просто)"
echo "✓ Продакшн: MIN_ACKS=0 (N/2+1, баланс, по умолчанию)"
echo "✓ Критичные данные: MIN_ACKS=-1 (все узлы, максимальная надежность)"
echo "✓ Используйте динамическое изменение через API для гибкости"
echo "✓ Тестируйте на реальных данных и нагрузке"
echo
